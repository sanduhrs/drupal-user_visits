<?php
/* $Id$ */

/**
 * @author
 * Stefan Auditor <stefan.auditor@erdfisch.de>
 */

/**
* Implementation of hook_help();
*/
function user_visits_help($section = '') {
  $output = '';

  switch ($section) {
    case "admin/help#user-visits":
      $output = '<p>'.  t("Counts the visits to a user's profile.") .'</p>';
      break;
  }

  return $output;
}

/**
* Implementation of hook_menu();
*/
function user_visits_menu($may_cache) {
  global $user;
  $items = array();

  if ($may_cache) {
    $items[] = array(
      'path' => 'admin/user/user_visits',
      'title' => t('User visits'),
      'description' => t("Configure where to display a user's visitors."),
      'callback' => 'drupal_get_form',
      'callback arguments' => 'user_visits_settings',
      'access' => user_access('administer user visits'),
    );
  }
  return $items;
}

/**
 * Implementation of hook_block().
 */
function user_visits_block($op = 'list', $delta = 0, $edit = array()) {
  if ($op == 'list') {
    $blocks[0] = array(
      'info' => t('User visits: latest visitors'),
    );
    $blocks[1] = array(
      'info' => t('User visits: my latest visitors'),
    );
    return $blocks;
  }
  else if ($op == 'configure') {
    $form['items'] = array(
      '#type' => 'select',
      '#title' => t('Number of items'),
      '#default_value' => variable_get('user_visits_block_items_'. $delta, 5),
      '#options' => drupal_map_assoc(array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20, 25)),
    );
    return $form;
  }
  else if ($op == 'save' && $delta == 0) {
    variable_set('user_visits_block_items', $edit['items']);
  }
  else if ($op == 'view') {
    $limit = variable_get('user_visits_block_items_'. $delta, 5);
    switch($delta) {
      case 0:
        $block = array(
          'subject' => t('Latest visitors'),
          'content' => user_visits_display_block_1(NULL, $limit),
          );
        break;
      case 1:
        global $user;
        $block = array(
          'subject' => t('My latest visitors'),
          'content' => user_visits_display_block_1($user->uid, $limit),
          );
        break;
    }
    return $block;
  }
}

/**
* Get latest visitors for block content
*/
function user_visits_display_block_1($uid = NULL, $limit = 5) {
  if (!$uid) {
    //try to determine the user's id
    if (arg(0) == 'user' && is_numeric(arg(1))) {
      $uid = arg(1);
    }
  }
  $output = '';
  
  $visitors = user_visits_latest($uid, $limit);
  if (is_array($visitors)) {
    foreach ($visitors as $visitor) {
      $account = user_load(array('uid' => $visitor->vuid));
      $output .= theme_user_visit($account, $visitor->visit);
    }
  }
  
  $output .= theme('user_visits_total', user_visits_total($uid));
  
  return $output;
}

/**
* Implementation of hook_perm();
*/
function user_visits_perm() {
  return array('administer user visits');
}

/**
* Implementation of hook_user();
*/
function user_visits_user($op, &$edit, &$account, $category = NULL) {
  global $user;

  switch ($op) {
    case 'view':
      //Don't count if role is hidden
      if (!user_visit_is_hidden($user)) {
        $referer = referer_uri();
        //Don't count anonymous- and self-clicks. Try not to count clicks from the user's other profile pages
        if ($user->uid && $user->uid != $account->uid && !strpos(referer_uri(), arg(0).'/'.arg(1))) {
          //Count view
          user_visits_count($user->uid, $account->uid);
        }
      }
      
      //Display visitors on the user's profile
      if (variable_get('user_activity_display', 0)) {
        $visitors = user_visits_latest($account->uid);
        if (is_array($visitors)) {
          foreach ($visitors as $visitor) {
            $account = user_load(array('uid' => $visitor->vuid));
            $output .= theme_user_visit($account, $visitor->visit, $visitor->referer);
          }
        }
  
        $items['user_visits_' .$i] = array(
          'title' => t('Latest visitors'),
          'value' => $output ? $output : t('No visits by now'),
          'class' => 'user-visits',
        );
        
        return array(t('User visits') => $items);
      }
      break;
    case 'delete':
      db_query("DELETE FROM {user_visits} WHERE uid=%d", $account->uid);
  	  break;
  }
  
}

/**
 * Update counter
 */
function user_visits_count($vuid, $uid) {
  db_query("DELETE FROM {user_visits} WHERE uid=%d AND vuid=%d", $uid, $vuid);
  db_query("INSERT INTO {user_visits} (uid, vuid, visit, referer) VALUES (%d, %d, %d, '%s')", $uid, $vuid, time(), referer_uri());
}

/**
 * Get the total of visits
 */
function user_visits_total($uid) {
  return db_result(db_query("SELECT COUNT(visit) AS count FROM {user_visits} WHERE uid=%d", $uid));
}

/**
 * Get the latest visits
 */
function user_visits_latest($uid, $limit = 5) {
  $result = db_query("SELECT * FROM {user_visits} WHERE uid=%d ORDER BY visit DESC LIMIT %d", $uid, $limit);
  while ($visitor = db_fetch_object($result)) {
    $visitors[] = $visitor;
  }

  return $visitors;
}

/**
 * Settings page
 */
function user_visits_settings() {
  $form['user_activity'] = array(
    '#type' => 'fieldset',
    '#title' => t('Display settings'),
    '#description' => t("Choose if you want the visitors to be displayed on the user's profile page or not. Alternatively you may use the provided !blocks to display a user's visitors.", array('!blocks' => l('blocks', 'admin/build/block'))),
  );
  $form['user_activity']['user_activity_display'] = array(
    '#type' => 'radios',
    '#default_value' => variable_get('user_visits_display', 0),
    '#options' => array(t("Don't display."), t('Display on user profile page')),
  );
  
  $roles = user_roles(TRUE);
  $form['user_activity_role'] = array(
    '#type' => 'fieldset',
    '#title' => t('moje nastavenie role'),
    '#description' => t("Choose roles and visits of selected roles will be not shown in user visit block."),
  );
  $form['user_activity_role']['user_visits_hidden_roles'] = array(
      '#type' => 'select',
      '#title' => t('Hidden Roles'),
      '#description' => t('visits of selected roles will be not shown in user visit block.'),
      '#options' => $roles,
      '#multiple' => TRUE,
      '#default_value' => variable_get('user_visits_hidden_roles', array()),      
  );
  
  return system_settings_form($form);
}

/**
 * Implementation of hook_nodeapi().
 */
function user_visits_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  global $user;
  
  switch ($op) {
    case 'view':
      if (!$a3) {
        if ((module_exists('nodeprofile') && is_nodeprofile($node->type)) OR (module_exists('usernode') && $nody->type == USERNODE_CONTENT_TYPE)) {
          //Don't count if role is hidden
          if (!user_visit_is_hidden($user)) {
            $referer = referer_uri();
            //Don't count anonymous- and self-clicks. Try not to count clicks from the user's other profile pages
            if ($user->uid && $user->uid != $node->uid && !strpos(referer_uri(), arg(0).'/'.arg(1))) {
              //Count view
              user_visits_count($user->uid, $node->uid);
            }
          }
        }
      }
      break;
  }
}

/**
 * Themeable function
 */
function theme_user_visit($account, $timestamp = NULL, $referer = NULL) {
  $output  = '<div class="profile">'."\n";
  $output .= theme('user_picture', $account);
  $output .= ' <div class="name">'. theme('username', $account) .'</div>'."\n";

  if ($timestamp) {
    $output .= $timestamp ? ' <div class="visit">'. t('!time ago', array('!time' => format_interval(time() - $timestamp))) .'</div>'."\n" : '';
    $output .= $referer ? ' <div class="referer">'. t('Referer !link', array('!link' => l($referer, $referer))) .'</div>'."\n" : '';
  }

  $output .= '</div>'."\n";

  return $output;
}

/**
 * Themeable function
 */
function theme_user_visits_total($total = 0) {
  $output = '<div class="user_visits_total">'. t('Total visits %total', array('%total' => $total)) .'</div>';
  
  return $output;
}

/**
 * Check if user should be counted
 */
function user_visit_is_hidden($user) {
  $intersect = array_intersect_key($user->roles, variable_get('user_visits_hidden_roles', array()));
  return count($intersect) ? count($intersect) : FALSE;
}
